/*! mentions-kinder - v0.1.0-beta5 - 2013-10-09
* https://mixxt.github.io/mentions-kinder.js
* Copyright (c) 2013 mixxt GmbH; Licensed MIT */
!function(a){function b(a,b){return a?Object.prototype.hasOwnProperty.call(a,b):!1}var c;c=function(){function b(b){null==b&&(b={}),this.mentionsKind=b.mentionsKind,this.options=b,this.initialize(),this.deferred=a.Deferred(),this.deferred.promise(this)}return b.prototype.initialize=function(){},b.prototype.complete=function(a){return this.deferred.resolve(a)},b.prototype.abort=function(){return this.deferred.reject()},b.prototype.search=function(){return a.error("implement #search in your autocompleter")},b}();var d,e=function(a,b){return function(){return a.apply(b,arguments)}};d=function(){function b(a,b){this.handleDelete=e(this.handleDelete,this),this.handlePlaceholder=e(this.handlePlaceholder,this),this.handleReset=e(this.handleReset,this),this.handlePaste=e(this.handlePaste,this),this.handleKeyup=e(this.handleKeyup,this),this.handleInput=e(this.handleInput,this),this.handleAutocompleteFail=e(this.handleAutocompleteFail,this),this.handleAutocompleteDone=e(this.handleAutocompleteDone,this),this.cleanEditable=e(this.cleanEditable,this),this.deserializeFromInput=e(this.deserializeFromInput,this),this.populateInput=e(this.populateInput,this),this._ensureInput(a),this._buildOptions(b),this._setupElements(),this._setupEvents(),this.$editable.attr("autofocus")&&this.$editable.focus()}var d,f;return d={RETURN:13,ESC:27},b.prototype.defaultOptions={trigger:{"@":{triggerName:"member"}},deserialize:function(a,b,c,d,e){var f,g;return f=null!=(g=this.options.trigger[b])?g.formatter:void 0,f?f({trigger:b,name:c,value:e,triggerOptions:{triggerName:d},serializedMention:a}).get(0):document.createTextNode(a)},deserializeRegex:/\[(.)(.+?)\]\((\w+):(.+?)\)/g},b.prototype.triggerDefaultOptions={autocompleter:c,formatter:function(b){var c,d,e,f;return e=a("<span class='"+b.triggerOptions.triggerName+"-trigger'></span>").text(b.trigger),f=a("<span class='"+b.triggerOptions.triggerName+"-value'></span>").text(b.name),d=a('<span class="mention label" contenteditable="false"></span>'),c=a("<span class='delete-mention "+b.triggerOptions.triggerName+"-delete'><i class='icon-remove'></i></span>"),d.append([e,f,c]),d.attr("serialized-mention",b.serializedMention),d},serializer:function(a){return"["+a.trigger+a.name+"]("+a.triggerOptions.triggerName+":"+a.value+")"}},b.prototype.populateInput=function(){var a,b;return a=this.serializeEditable(),null!=(b=this.$input)&&b.val(a),this.$originalInput.trigger("mentions-kinder-change",a)},b.prototype.serializeEditable=function(){return this._serializeNode(this.$editable[0]).join("")},b.prototype.deserializeFromInput=function(){return this.$editable.html(this._deserialize(this.$originalInput.val()))},b.prototype.cleanEditable=function(){return this._cleanChildNodes(this.$editable[0])},b.prototype.focus=function(){return this.$editable.focus()},b.prototype.startAutocomplete=function(b){var c,d,e;return this._current={trigger:b,triggerOptions:this.trigger[b],$tempMention:a("<span class='mention temp-mention label'>"+b+"</span>")},e=this._current.$tempMention.get(0),d=rangy.getSelection(),c=d.getRangeAt(0),c.insertNode(e),c.selectNodeContents(e),d.setSingleRange(c),d.collapseToEnd(),this._current.autocompleter=new this._current.triggerOptions.autocompleter({mentionsKind:this}),this._current.autocompleter.done(this.handleAutocompleteDone),this._current.autocompleter.fail(this.handleAutocompleteFail),this._current.autocompleter.always(this.populateInput),this._current.autocompleter.search("")},b.prototype.updateAutocomplete=function(){var a,b;return a=this._current.$tempMention.text(),b=this._current.trigger.length,a.slice(0,b)===this._current.trigger?this._current.autocompleter.search(a.slice(b)):this.abortAutocomplete()},b.prototype.isAutocompleting=function(){return null!=this._current?a.contains(this.$editable,this._current.$tempMention)?!0:(this._current.autocompleter.abort(),this._current=null,!1):!1},b.prototype.abortAutocomplete=function(){return this.isAutocompleting()&&this._current.autocompleter.abort()},b.prototype.handleAutocompleteDone=function(b){var c,d;return b=a.extend({},this._current,b),b.serializedMention=this._current.triggerOptions.serializer(b),c=this._current.triggerOptions.formatter(b),d=document.createTextNode(String.fromCharCode(160)),a(d).insertAfter(this._current.$tempMention),this.$editable.focus(),this._setCaretToEndOf(d),this._current.$tempMention.replaceWith(c),this._current=null},b.prototype.handleAutocompleteFail=function(){var a;return a=document.createTextNode(this._current.$tempMention.text()),this._current.$tempMention.replaceWith(a),this._setCaretToEndOf(a),this._current=null},b.prototype.handleInput=function(a){var b,c;return c=a.charCode||a.which||a.keyCode,b=String.fromCharCode(c),!this.isAutocompleting()&&this.trigger[b]&&(a.preventDefault(),this.startAutocomplete(b)),c===d.RETURN&&!this.multiline&&(a.preventDefault(),this.submitOnEnter)?this.$form.submit():void 0},b.prototype.handleKeyup=function(a){switch(this.isAutocompleting()&&this.updateAutocomplete(),a.keyCode){case d.ESC:this.abortAutocomplete()}return this.isAutocompleting()&&!this._isCaretInTempMention()&&this.abortAutocomplete(),this.populateInput()},b.prototype.handlePaste=function(){return setTimeout(this.cleanEditable,0)},b.prototype.handleReset=function(){return this.$editable.empty().blur(),this.$input.val(this.$originalInput.val())},b.prototype.handlePlaceholder=function(a){var b;return"focus"===a.type?null!=(b=this.$placeholder)?b.detach():void 0:"blur"!==a.type&&"reset"!==a.type||""!==this._strip(this.serializeEditable())?void 0:this.$editable.empty().append(this.$placeholder)},b.prototype.handleDelete=function(b){var c,d;return b.preventDefault(),c=a(b.target).parents(".mention"),c?(d=c.get(0).nextSibling,d&&this._setCaretToStartOf(d),c.remove(),this.populateInput()):void 0},b.prototype._ensureInput=function(b){return this.$originalInput=a(b),this.$originalInput.is("input[type=text],textarea")||a.error("$.mentionsKinder works only on input[type=text] or textareas, was "+(b&&b.tagName)),this.multiline=this.$originalInput.is("textarea")},b.prototype._buildOptions=function(b){var c=this;return this.options=a.extend({},this.defaultOptions,b),a.each(this.options.trigger,function(b,d){return c.options.trigger[b]=a.extend({},c.triggerDefaultOptions,d)}),this.trigger=this.options.trigger||{}},b.prototype._setupElements=function(){var b,c;return this.$wrap=a('<div class="mentions-kinder-wrap"></div>'),this.$editable=a('<div class="form-control mentions-kinder" contenteditable="true"></div>'),this.$editable.addClass("mentions-kinder-"+(this.multiline?"multiline":"singleline")),this.$input=a("<input type='hidden'/>"),this.$input.attr("name",this.$originalInput.attr("name")),this.$input.val(this.$originalInput.val()),this.$editable.addClass(this.$originalInput.attr("class")),(b=this.$originalInput.attr("autofocus"))&&this.$editable.attr("autofocus",b),""!==this.$originalInput.val()&&this.deserializeFromInput(),(c=this.$originalInput.attr("placeholder"))&&(this.$placeholder=a("<span class='placeholder'>"+c+"</span>").appendTo(this.$editable)),this.$wrap.insertAfter(this.$originalInput),this.$originalInput.hide().appendTo(this.$wrap),this.$input.appendTo(this.$wrap),this.$editable.appendTo(this.$wrap),void 0},b.prototype._setupEvents=function(){var b;return this.$editable.bind("keypress",this.handleInput),this.$editable.bind("keyup",this.handleKeyup),this.$editable.bind("paste",this.handlePaste),this.$editable.bind("focus blur",this.handlePlaceholder),this.$editable.on("click",".delete-mention",this.handleDelete),this.$originalInput.bind("change",this.deserializeFromInput),(b=this.$originalInput.get(0).form)?(this.$form=a(b),this.multiline||(this.submitOnEnter=!0),this.$form.on("reset",this.handleReset),this.$form.on("reset",this.handlePlaceholder)):void 0},f=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b);return e},b.prototype._cleanChildNodes=function(a){var b,c,d,e;for(e=f(a.childNodes),c=0,d=e.length;d>c;c++)b=e[c],this._cleanNode(b);return!0},b.prototype._cleanNode=function(b){var c;return 3===b.nodeType||("BR"===b.nodeName?this.multiline||a(b).replaceWith(" "):a(b).attr("serialized-mention")?a(b).attr("contenteditable",!1):(null!=(c=b.childNodes)?c.length:void 0)>0?(this._cleanChildNodes(b),a(b).replaceWith(b.childNodes)):a(b).remove()),!0},b.prototype._serializeNode=function(b){var c,d,e,f,g,h,i,j;for(e=[],h=b.childNodes,f=0,g=h.length;g>f;f++)c=h[f],3===c.nodeType?e.push(c.data):"BR"===c.nodeName.toUpperCase()?e.push("\n"):(d=a(c).attr("serialized-mention"))?e.push(d):"P"===c.nodeName.toUpperCase()||"DIV"===c.nodeName.toUpperCase()?("BR"!==(null!=(i=c.childNodes[0])?null!=(j=i.nodeName)?j.toUpperCase():void 0:void 0)&&e.push("\n"),e=e.concat(this._serializeNode(c))):e=e.concat(this._serializeNode(c));return e},b.prototype._deserialize=function(a){var b,c,d,e,f;for(f=[],e=this.options.deserializeRegex,d=0;;){if(c=e.exec(a),!c){d!==a.length&&(b=a.substring(d,a.length),""!==b&&this._deserializeText.call(f,b));break}0!==c.index&&this._deserializeText.call(f,a.substring(d,c.index)),d=e.lastIndex,f.push(this.options.deserialize.apply(this,c))}return f},b.prototype._deserializeText=function(a){var b,c,d,e,f,g;for(d=a.split("\n"),g=[],b=e=0,f=d.length;f>e;b=++e)c=d[b],this.push(document.createTextNode(c)),b!==d.length-1?g.push(this.push(document.createElement("br"))):g.push(void 0);return g},b.prototype._prepareSetCaretTo=function(a){var b,c;return c=rangy.getSelection(),b=c.getRangeAt(0),b.selectNodeContents(a),c.setSingleRange(b),c},b.prototype._setCaretToEndOf=function(a){return this._prepareSetCaretTo(a).collapseToEnd()},b.prototype._setCaretToStartOf=function(a){return this._prepareSetCaretTo(a).collapseToStart()},b.prototype._isCaretInTempMention=function(){var a;return this.isAutocompleting()?(a=rangy.getSelection().getRangeAt(0),(null!=a?a.compareNode(this._current.$tempMention.get(0)):void 0)===a.NODE_BEFORE_AND_AFTER):void 0},b.prototype._strip=function(a){return a.replace(/^\s*(.*?)\s*$/gm,"$1")},b}(),d.Autocompleter=c,a.fn.mentionsKinder=function(b){return this.each(function(){var c;return c=a(this).data("mentionsKinder"),void 0===c?a(this).data("mentionsKinder",new a.MentionsKinder(this,b)):void 0})},a.MentionsKinder=d,a.MentionsKinder.defaultOptions=d.prototype.defaultOptions,a.MentionsKinder.triggerDefaultOptions=d.prototype.triggerDefaultOptions,a(function(){return rangy.init()});var f=function(c,d){var e,f=this;e=c&&b(c,"constructor")?c.constructor:function(){return f.apply(this,arguments)},a.extend(e,f,d);var g=function(){this.constructor=e};return g.prototype=f.prototype,e.prototype=new g,c&&a.extend(e.prototype,c),e.__super__=f.prototype,e};d.extend=c.extend=f,c.DummyAutocompleter=c.extend({timeout:2e3,search:function(a){var b,c=this;return this.timer&&clearTimeout(this.timer),b=~~(1e3*Math.random()),this.timer=setTimeout(function(){return c.deferred.resolve({name:a,value:b})},this.timeout)}}),c.Select2Autocompleter=c.extend({select2Options:{data:[]},initialize:function(){var b=this;return this._setupInput(),this.$input.on("select2-selecting",function(c){var d;return d=a.extend({},{name:c.object.text,value:c.object.id},c.object),b.complete.call(b,d),b.$input.select2("destroy").remove()}),this.$input.on("select2-close",function(){return b.abort.call(b),b.$input.select2("destroy").remove()})},search:a.noop,_setupInput:function(){return this.$input=a('<input type="hidden" />').css("width",this.mentionsKind.$editable.width()).appendTo(this.mentionsKind.$wrap),this.$input.select2(this.select2Options),this.$input.select2("open")}}),d.triggerDefaultOptions.autocompleter=c.Select2Autocompleter}(jQuery);