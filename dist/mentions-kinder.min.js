/*! mentions-kinder - v0.1.0-alpha1 - 2013-09-26
* https://mixxt.github.io/mentions-kinder.js
* Copyright (c) 2013 mixxt GmbH; Licensed MIT */
!function(a){function b(a,b){return a?Object.prototype.hasOwnProperty.call(a,b):!1}var c;c=function(){function b(b){null==b&&(b={}),this.mentionsKind=b.mentionsKind,this.options=b,this.initialize(),this.deferred=a.Deferred(),this.deferred.promise(this)}return b.prototype.initialize=function(){},b.prototype.complete=function(a){return this.deferred.resolve(a)},b.prototype.abort=function(){return this.deferred.reject()},b.prototype.search=function(){return a.error("implement #search in your autocompleter")},b}();var d,e=function(a,b){return function(){return a.apply(b,arguments)}};d=function(){function b(a,b){this.populateInput=e(this.populateInput,this),this.handleAutocompleteFail=e(this.handleAutocompleteFail,this),this.handleAutocompleteDone=e(this.handleAutocompleteDone,this),this.cleanEditable=e(this.cleanEditable,this),this.handlePaste=e(this.handlePaste,this),this.handleKeyup=e(this.handleKeyup,this),this.handleInput=e(this.handleInput,this),this._ensureInput(a),this._buildOptions(b),this._setupElements(),this._setupEvents()}var d,f;return d={RETURN:13,ESC:27},b.prototype.defaultOptions={trigger:{"@":{triggerName:"member"}}},b.prototype.triggerDefaultOptions={autocompleter:c,formatter:function(b){var c,d;return c=a("<span class='"+b.triggerOptions.triggerName+"-trigger'></span>").text(b.trigger),d=a("<span class='"+b.triggerOptions.triggerName+"-value'></span>").text(b.name),a('<span class="mention label" contenteditable="false"></span>').append(c).append(d)},serializer:function(a){return"["+a.trigger+a.name+"]("+a.triggerOptions.triggerName+":"+a.value+")"}},b.prototype.handleInput=function(a){var b,c;return c=a.charCode||a.which||a.keyCode,b=String.fromCharCode(c),!this.isAutocompleting()&&this.trigger[b]&&(a.preventDefault(),this.startAutocomplete(b)),c!==d.RETURN||this.multiline?void 0:a.preventDefault()},b.prototype.handleKeyup=function(a){switch(this.isAutocompleting()&&this.updateAutocomplete(),a.keyCode){case d.ESC:this.abortAutocomplete()}return this.isAutocompleting()&&!this._isCaretInTempMention()&&this.abortAutocomplete(),this.populateInput()},b.prototype.handlePaste=function(){return setTimeout(this.cleanEditable,0)},b.prototype.cleanEditable=function(){return this.cleanChildNodes(this.$editable[0])},b.prototype.startAutocomplete=function(b){var c,d,e;return"undefined"!=typeof console&&null!==console&&console.log("Start autocomplete for "+b),this._current={trigger:b,triggerOptions:this.trigger[b],$tempMention:a("<span class='mention temp-mention label'>"+b+"</span>")},e=this._current.$tempMention.get(0),d=rangy.getSelection(),c=d.getRangeAt(0),c.insertNode(e),c.selectNodeContents(e),d.setSingleRange(c),d.collapseToEnd(),this._current.autocompleter=new this._current.triggerOptions.autocompleter({mentionsKind:this}),this._current.autocompleter.done(this.handleAutocompleteDone),this._current.autocompleter.fail(this.handleAutocompleteFail),this._current.autocompleter.always(this.populateInput),this._current.autocompleter.search("")},b.prototype.updateAutocomplete=function(){var a,b;return a=this._current.$tempMention.text(),b=this._current.trigger.length,a.slice(0,b)===this._current.trigger?this._current.autocompleter.search(a.slice(b)):this.abortAutocomplete()},b.prototype.isAutocompleting=function(){return null!=this._current},b.prototype.abortAutocomplete=function(){return this.isAutocompleting()&&this._current.autocompleter.abort()},b.prototype.handleAutocompleteDone=function(b){var c,d,e;return"undefined"!=typeof console&&null!==console&&console.log("Autocomplete done",b),b=a.extend({},this._current,b),c=this._current.triggerOptions.formatter(b),e=this._current.triggerOptions.serializer(b),c.attr("serialized-mention",e),d=document.createTextNode(String.fromCharCode(160)),a(d).insertAfter(this._current.$tempMention),this._setCaretToEndOf(d),this._current.$tempMention.replaceWith(c),this._current=null},b.prototype.handleAutocompleteFail=function(){var a;return"undefined"!=typeof console&&null!==console&&console.log("Autocomplete fail"),a=document.createTextNode(this._current.$tempMention.text()),this._current.$tempMention.replaceWith(a),this._setCaretToEndOf(a),this._current=null},b.prototype.populateInput=function(){var a,b;return a=this.serializeEditable(),this.$originalInput.val(a),null!=(b=this.$input)?b.val(a):void 0},b.prototype.serializeEditable=function(){return this.serializeNode(this.$editable[0]).join("")},b.prototype.serializeNode=function(b){var c,d,e,f,g,h;for(e=[],h=b.childNodes,f=0,g=h.length;g>f;f++)c=h[f],3===c.nodeType?e.push(c.data):"BR"===c.nodeName?e.push("\n"):(d=a(c).attr("serialized-mention"))?e.push(d):e=e.concat(this.serializeNode(c));return e},f=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b);return e},b.prototype.cleanChildNodes=function(a){var b,c,d,e;for(e=f(a.childNodes),c=0,d=e.length;d>c;c++)b=e[c],this.cleanNode(b);return!0},b.prototype.cleanNode=function(b){var c;return 3===b.nodeType||("BR"===b.nodeName?this.multiline||a(b).replaceWith(" "):a(b).attr("serialized-mention")?a(b).attr("contenteditable",!1):(null!=(c=b.childNodes)?c.length:void 0)>0?(this.cleanChildNodes(b),a(b).replaceWith(b.childNodes)):a(b).remove()),!0},b.prototype.deserializeInput=function(){return document.createTextNode(this.$originalInput.val())},b.prototype._ensureInput=function(b){return this.$originalInput=a(b),this.$originalInput.is("input[type=text],textarea")||a.error("$.mentionsKinder works only on input[type=text] or textareas, was "+(b&&b.tagName)),this.multiline=this.$originalInput.is("textarea")},b.prototype._buildOptions=function(b){var c=this;return this.options=a.extend({},this.defaultOptions,b),a.each(this.options.trigger,function(b,d){return c.options.trigger[b]=a.extend({},c.triggerDefaultOptions,d)}),this.trigger=this.options.trigger||{}},b.prototype._setupElements=function(){return this.$wrap=a('<div class="mentions-kinder-wrap"></div>'),this.$editable=a('<div class="form-control" contenteditable="true"></div>'),this.$editable.addClass("mentions-kinder-"+(this.multiline?"multiline":"singleline")),this.$input=a("<input type='hidden' name='"+this.$originalInput.attr("name")+"'/>"),this.$input.val(this.$originalInput.val()),this.$editable.addClass(this.$originalInput.attr("class")).html(this.deserializeInput()),this.$wrap.insertAfter(this.$originalInput),this.$originalInput.hide().appendTo(this.$wrap),this.$input.appendTo(this.$wrap),this.$editable.appendTo(this.$wrap),void 0},b.prototype._setupEvents=function(){return this.$editable.bind("keypress",this.handleInput),this.$editable.bind("keyup",this.handleKeyup),this.$editable.bind("paste",this.handlePaste)},b.prototype._setCaretToEndOf=function(a){var b,c;return c=rangy.getSelection(),b=c.getRangeAt(0),b.selectNodeContents(a),c.setSingleRange(b),c.collapseToEnd()},b.prototype._isCaretInTempMention=function(){var a;return this.isAutocompleting()?(a=rangy.getSelection().getRangeAt(0),(null!=a?a.compareNode(this._current.$tempMention.get(0)):void 0)===a.NODE_BEFORE_AND_AFTER):void 0},b}(),d.Autocompleter=c,a.fn.mentionsKinder=function(b){return this.each(function(){var c;return c=a(this).data("mentionsKinder"),void 0===c?a(this).data("mentionsKinder",new a.MentionsKinder(this,b)):void 0})},a.MentionsKinder=d,a.MentionsKinder.defaultOptions=d.prototype.defaultOptions,a.MentionsKinder.triggerDefaultOptions=d.prototype.triggerDefaultOptions,a(rangy.init);var f=function(c,d){var e,f=this;e=c&&b(c,"constructor")?c.constructor:function(){return f.apply(this,arguments)},a.extend(e,f,d);var g=function(){this.constructor=e};return g.prototype=f.prototype,e.prototype=new g,c&&a.extend(e.prototype,c),e.__super__=f.prototype,e};d.extend=c.extend=f,c.DummyAutocompleter=c.extend({timeout:2e3,search:function(a){var b,c=this;return this.timer&&clearTimeout(this.timer),b=~~(1e3*Math.random()),this.timer=setTimeout(function(){return c.deferred.resolve({name:a,value:b})},this.timeout)}}),c.Select2Autocompleter=c.extend({select2Options:{data:[]},initialize:function(){var a=this;return this._setupInput(),this.$input.on("select2-selecting",function(b){return a.complete.call(a,{name:b.object.text,value:b.object.id}),a.$input.select2("destroy").remove()}),this.$input.on("select2-close",function(){return a.abort.call(a),a.$input.select2("destroy").remove()})},search:a.noop,_setupInput:function(){return this.$input=a('<input type="hidden" />').css("width",this.mentionsKind.$editable.width()).appendTo(this.mentionsKind.$wrap),this.$input.select2(this.select2Options),this.$input.select2("open")}}),d.triggerDefaultOptions.autocompleter=c.Select2Autocompleter}(jQuery);