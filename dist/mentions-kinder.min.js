/*! mentions-kinder - v0.0.0 - 2013-09-09
* https://github.com/mixxt/mentions-kinder.js
* Copyright (c) 2013 Christoph; Licensed MIT */
!function(a){function b(a,b){return a?hasOwnProperty.call(a,b):!1}var c;c=function(){function b(b){null==b&&(b={}),this.mentionsKind=b.mentionsKind,this.options=b,this.initialize(),this.deferred=a.Deferred(),this.deferred.promise(this)}return b.prototype.initialize=function(){},b.prototype.complete=function(a){return this.deferred.resolve(a)},b.prototype.abort=function(){return this.deferred.reject()},b.prototype.search=function(){return a.error("implement #search in your autocompleter")},b}();var d,e=function(a,b){return function(){return a.apply(b,arguments)}};d=function(){function b(a,b){this.populateInput=e(this.populateInput,this),this.handleAutocompleteFail=e(this.handleAutocompleteFail,this),this.handleAutocompleteDone=e(this.handleAutocompleteDone,this),this.cleanEditable=e(this.cleanEditable,this),this.handlePaste=e(this.handlePaste,this),this.handleKeyup=e(this.handleKeyup,this),this.handleInput=e(this.handleInput,this),this._ensureInput(a),this._buildOptions(b),this._setupElements(),this._setupEvents(),window.foo=this}var d,f;return d={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},b.prototype.defaultOptions={trigger:{"@":{triggerName:"member"}}},b.prototype.triggerDefaultOptions={autocompleter:c,formatter:function(b){var c;return c=a("<span class='"+b.triggerOptions.triggerName+"-trigger'></span>").text(b.trigger),a('<span class="mention label btn-primary active" disabled contenteditable="false"></span>').text(b.name).prepend(c)},serializer:function(a){return"["+a.trigger+a.name+"]("+a.triggerOptions.triggerName+":"+a.value+")"}},b.prototype.handleInput=function(a){var b,c;return c=a.charCode||a.which||a.keyCode,b=String.fromCharCode(c),!this.isAutocompleting()&&this.trigger[b]?(a.preventDefault(),this.startAutocomplete(b)):void 0},b.prototype.handleKeyup=function(a){switch(this.isAutocompleting()&&this.updateAutocomplete(),a.keyCode){case d.ESC:this.abortAutocomplete()}return this._isCaretInTempMention()||this.abortAutocomplete(),this.populateInput()},b.prototype.handlePaste=function(){return setTimeout(this.cleanEditable,0)},b.prototype.cleanEditable=function(){return this.cleanChildNodes(this.$editable[0])},b.prototype.startAutocomplete=function(b){var c;return"undefined"!=typeof console&&null!==console&&console.log("Start autocomplete for "+b),this._current={trigger:b,triggerOptions:this.trigger[b],$tempMention:a("<span class='mention temp-mention label btn-info active'>"+b+"</span>").appendTo(this.$editable)},this._current.autocompleter=new this._current.triggerOptions.autocompleter({mentionsKind:this}),this._current.autocompleter.done(this.handleAutocompleteDone),this._current.autocompleter.fail(this.handleAutocompleteFail),this._current.autocompleter.always(this.populateInput),this._current.autocompleter.search(""),c=document.createTextNode(" "),a(c).insertAfter(this._current.$tempMention),this._focusTempMention()},b.prototype.updateAutocomplete=function(){var a,b;return a=this._current.$tempMention.text(),b=this._current.trigger.length,a.slice(0,b)===this._current.trigger?this._current.autocompleter.search(a.slice(b)):this.abortAutocomplete()},b.prototype.isAutocompleting=function(){return null!=this._current},b.prototype.abortAutocomplete=function(){return this.isAutocompleting()&&this._current.autocompleter.abort()},b.prototype.handleAutocompleteDone=function(b){var c,d;return"undefined"!=typeof console&&null!==console&&console.log("Autocomplete done",b),b=a.extend({},this._current,b),c=this._current.triggerOptions.formatter(b),d=this._current.triggerOptions.serializer(b),c.attr("serialized-mention",d),this._current.$tempMention.replaceWith(c),this._setCaretPosition(this.$editable[0],1,c[0].nextSibling),this._current=null},b.prototype.handleAutocompleteFail=function(){var a,b;return"undefined"!=typeof console&&null!==console&&console.log("Autocomplete fail"),a=this._isCaretInTempMention()?this._getCaretPosition(this._current.$tempMention[0]):void 0,b=document.createTextNode(this._current.$tempMention.text()),this._current.$tempMention.replaceWith(b),a?this._setCaretPosition(this.$editable[0],a,b):this._setCaretPosition(this.$editable[0],b.length,b),this._current=null},b.prototype.populateInput=function(){var a,b;return a=this.serializeEditable(),this.$originalInput.val(a),null!=(b=this.$input)?b.val(a):void 0},b.prototype.serializeEditable=function(){return this.serializeNode(this.$editable[0]).join("")},b.prototype.serializeNode=function(b){var c,d,e,f,g,h;for(e=[],h=b.childNodes,f=0,g=h.length;g>f;f++)c=h[f],3===c.nodeType?e.push(c.data):(d=a(c).attr("serialized-mention"))?e.push(d):e=e.concat(this.serializeNode(c));return e},f=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b);return e},b.prototype.cleanChildNodes=function(a){var b,c,d,e;for(e=f(a.childNodes),c=0,d=e.length;d>c;c++)b=e[c],this.cleanNode(b);return!0},b.prototype.cleanNode=function(b){var c;return 3===b.nodeType||a(b).attr("serialized-mention")||((null!=(c=b.childNodes)?c.length:void 0)>0?(this.cleanChildNodes(b),a(b).replaceWith(b.childNodes)):a(b).remove()),!0},b.prototype.deserializeInput=function(){return document.createTextNode(this.$originalInput.val())},b.prototype._ensureInput=function(b){return this.$originalInput=a(b),this.$originalInput.is("input[type=text],textarea")?void 0:a.error("$.mentionsKinder works only on input[type=text] or textareas, was "+(b&&b.tagName))},b.prototype._buildOptions=function(b){var c=this;return this.options=a.extend({},this.defaultOptions,b),a.each(this.options.trigger,function(b,d){return c.options.trigger[b]=a.extend({},c.triggerDefaultOptions,d)}),this.trigger=this.options.trigger||{}},b.prototype._setupElements=function(){return this.$wrap=a('<div class="mentions-kinder-wrap"></div>'),this.$editable=a('<pre class="mentions-kinder-input form-control" contenteditable="true"></pre>'),this.$input=a("<input type='hidden' name='"+this.$originalInput.attr("name")+"'/>"),this.$input.val(this.$originalInput.val()),this.$editable.addClass(this.$originalInput.attr("class")).html(this.deserializeInput()),this.$wrap.insertAfter(this.$originalInput),this.$originalInput.hide().appendTo(this.$wrap),this.$input.appendTo(this.$wrap),this.$editable.appendTo(this.$wrap)},b.prototype._setupEvents=function(){return this.$editable.bind("keypress",this.handleInput),this.$editable.bind("keyup",this.handleKeyup),this.$editable.bind("paste",this.handlePaste)},b.prototype._focusTempMention=function(){var a,b,c,d;return this.isAutocompleting()?(a=this._current.$tempMention[0],b=a.firstChild,c=this._current.trigger.length,document.selection?(a.focus(),b.nodeValue=b.nodeValue+" ",d=document.body.createTextRange(),d.moveToElementText(a),d.moveStart("character",c),d.select()):this._setCaretPosition(a,c,b)):void 0},b.prototype._setCaretPosition=function(a,b,c){return c||(c=a.firstChild),"function"==typeof window.getSelection?window.getSelection().collapse(c,b):void 0},b.prototype._getCaretPosition=function(){return"function"==typeof window.getSelection?window.getSelection().baseOffset:void 0},b.prototype._isCaretInTempMention=function(){var a;return this.isAutocompleting()?document.selection?!0:(null!=(a=window.getSelection().baseNode)?a.parentElement:void 0)===this._current.$tempMention[0]:void 0},b}(),d.Autocompleter=c,a.fn.mentionsKinder=function(b){return this.each(function(){var c;return c=a(this).data("mentionsKinder"),void 0===c?a(this).data("mentionsKinder",new a.MentionsKinder(this,b)):void 0})},a.MentionsKinder=d,a.MentionsKinder.defaultOptions=d.prototype.defaultOptions,a.MentionsKinder.triggerDefaultOptions=d.prototype.triggerDefaultOptions;var f,g={}.hasOwnProperty,h=function(a,b){function c(){this.constructor=a}for(var d in b)g.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};c.DummyAutocompleter=function(a){function b(){return f=b.__super__.constructor.apply(this,arguments)}return h(b,a),b.prototype.timeout=2e3,b.prototype.search=function(a){var b,c=this;return this.timer&&clearTimeout(this.timer),b=~~(1e3*Math.random()),this.timer=setTimeout(function(){return c.deferred.resolve({name:a,value:b})},this.timeout)},b}(c);var i=function(c,d){var e,f=this;e=c&&b(c,"constructor")?c.constructor:function(){return f.apply(this,arguments)},a.extend(e,f,d);var g=function(){this.constructor=e};return g.prototype=f.prototype,e.prototype=new g,c&&a.extend(e.prototype,c),e.__super__=f.prototype,e};d.extend=c.extend=i,c.Select2Autocompleter=c.extend({select2Options:{data:[]},initialize:function(){var a=this;return this._setupInput(),this.$input.on("select2-selecting",function(b){return a.complete.call(a,{name:b.object.text,value:b.object.id}),a.$input.select2("destroy").remove()}),this.$input.on("select2-close",function(){return a.abort.call(a),a.$input.select2("destroy").remove()})},search:a.noop,_setupInput:function(){return this.$input=a('<input type="hidden" />').css("width",this.mentionsKind.$editable.width()).appendTo(this.mentionsKind.$wrap),this.$input.select2(this.select2Options),this.$input.select2("open")}}),d.triggerDefaultOptions.autocompleter=c.Select2Autocompleter}(jQuery);